---
title: 'OHIBC: Calculate FIS scores'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 8, fig.height = 6, echo = TRUE, message = FALSE, warning = FALSE, fig.path = 'figs/')

dir_git <- '~/github/ohibc'
source(file.path(dir_git, 'src/R/common.R'))  ### an OHIBC specific version of common.R
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
dir_anx <- file.path(dir_M, 'git-annex/bcprep')


### support scripts
#source(file.path(dir_git, 'src/R/rast_tools.R')) 
source("~/github/ohibc/calc_ohibc/calc_scores_fxns.R")

```

# Summary

This script takes the output from `functions.R` FIS model and plots individual stock scores by year and relative contribution to score.

This model has the following characteristics:

- Stock scores are weighted by proportional catch  
- A penalty for unassessed catch is applied to the status, equal to 1 minues the % of unassessed catch  
- Underfishing penalty is now at 0.66 instead of 0.8 (meaning F/Fmsy >= 0.66 & <= 1.2 is assigned a score of 1)

------

```{r source fisheries function}
#this runs the fisheries goal model and produces stock_scores.csv and fis_status.csv
source("fis_function.R")

```


## Stock scores and overall scores by region

``` {r assemble_dataframe}

## plotting fishery catch weighting by region
stock_plot_df <- read_csv('output/stock_scores.csv') %>%
  group_by(rgn_name, rgn_id, rgn_code, year) %>%
  mutate(avg = mean(score, na.rm = T)) 

```



``` {r plot_fis_stock_scores}

rgn_avg <- stock_plot_df %>%
  select(rgn_id, year, avg, rgn_name) %>%
  rename(score = avg) %>%
  distinct()

ggplot(stock_plot_df, aes(x = year, y = score)) +
    ggtheme_plot() +
    geom_line(aes(group = stock_id, color = stock_id),
              lineend = 'round', alpha = 0.8) +
    labs(color = 'Stock ID',
         y     = 'Stock Score') +
    guides(colour = guide_legend(override.aes = list(size = 3)),
           size = 'none') +
    facet_wrap(~rgn_name) +
    geom_line(data = rgn_avg, aes(x = year, y = score, group = rgn_name), color = "black", lwd = 1)

```


I want to look at catch over time by region. Need to plot each stock as a line but differentiate between assessed and unassessed.

```{r}

dfo_catch <- read_csv("output/dfo_catch.csv") %>%
  select(year, rgn_name, species, harvest_kgs, assessed) %>%
  distinct() %>%
  mutate(assessed = ifelse(assessed == 1, "assessed", "unassessed"))

ggplot(dfo_catch, aes(x = year, y = harvest_kgs, color = species)) +
  geom_line(aes(linetype = assessed)) +
  facet_wrap(~rgn_name, scales = "free")

```

#Fisheries status scores

``` {r plot_fis_status_scores}

status <- read_csv("output/fis_status.csv")

ggplot(status, aes(x = year, y = score, group = rgn_name)) +
    ggtheme_plot() +
    geom_line(aes(color = rgn_name), alpha = 0.8) +
    labs(color = 'Region',
         y     = 'Fisheries Status') +
    ggtitle("Fisheries status in British Columbia")

```

Let's look at proportion of unassessed catch over time for each region.

```{r}
unass <- read_csv("output/rgn_catch_summary.csv")
ggplot(unass, aes(x = year, y = unass_catch_prop, color = rgn_name)) +
  ggtheme_plot() +
  geom_line()

```










